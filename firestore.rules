rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function uid() {
      return request.auth.uid;
    }

    function emailLower() {
      return request.auth.token.email != null
        ? request.auth.token.email.lower()
        : null;
    }

    // ✅ Acepta variantes de claim
    function isSuperAdmin() {
      return signedIn() && (
        request.auth.token.super_admin == true ||
        request.auth.token.superadmin == true ||
        request.auth.token.superAdmin == true
      );
    }

    match /users/{userId} {
      allow read: if signedIn() && (isSuperAdmin() || uid() == userId);
      allow create: if signedIn() && uid() == userId;
      allow update: if signedIn() && (uid() == userId || isSuperAdmin());
      allow delete: if false;
    }

    function staffPath(centerId, staffUid) {
      return /databases/$(database)/documents/centers/$(centerId)/staff/$(staffUid);
    }

    function staffDoc(centerId) {
      return get(staffPath(centerId, uid()));
    }

    function isStaff(centerId) {
      return signedIn()
        && exists(staffPath(centerId, uid()))
        && staffDoc(centerId).data.active == true;
    }

    function staffAccessRole(centerId) {
      return isStaff(centerId)
        ? (staffDoc(centerId).data.accessRole != null
          ? staffDoc(centerId).data.accessRole
          : staffDoc(centerId).data.role)
        : null;
    }

    function isCenterAdmin(centerId) {
      let role = staffAccessRole(centerId);
      let r = role == null ? "" : role.lower();
      return isStaff(centerId) && (
        r == "center_admin" || 
        r == "admin_centro" || 
        r == "admin"
      );
    }

    function isAdministrative(centerId) {
      let role = staffAccessRole(centerId);
      let r = role == null ? "" : role.lower();
      return isStaff(centerId) && (
        r == "administrativo" || 
        r == "administrativa" || 
        r == "secretaria"
      );
    }


    function isDoctor(centerId) {
      return isStaff(centerId) && staffAccessRole(centerId) == "doctor";
    }

    function centerDoc(centerId) {
      return get(/databases/$(database)/documents/centers/$(centerId));
    }

    function centerAccessMode(centerId) {
      return centerDoc(centerId).data.accessMode;
    }

    function isCareTeamMode(centerId) {
      return centerAccessMode(centerId) == "CARE_TEAM";
    }

    function isCareTeamMemberFromResource() {
      return resource.data.careTeamUids is list
        && uid() in resource.data.careTeamUids;
    }

    function isCareTeamMember(centerId, patientId) {
      let patientDoc = get(/databases/$(database)/documents/centers/$(centerId)/patients/$(patientId));
      return patientDoc.data.careTeamUids is list
        && uid() in patientDoc.data.careTeamUids;
    }

    function canUpdateAnthropometryFeature(centerId) {
      return isCenterAdmin(centerId)
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(["features"])
        && request.resource.data.features is map
        && request.resource.data.features.keys().hasOnly(["anthropometryEnabled"])
        && request.resource.data.features.anthropometryEnabled is bool;
    }

    function canUpdateAccessMode(centerId) {
      return isCenterAdmin(centerId)
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(["accessMode"])
        && request.resource.data.accessMode is string
        && (request.resource.data.accessMode == "CENTER_WIDE"
          || request.resource.data.accessMode == "CARE_TEAM");
    }

    function canViewAudit(centerId) {
      return isSuperAdmin() || isCenterAdmin(centerId);
    }

    function canUpdateMarketingRetention(centerId) {
      return isCenterAdmin(centerId)
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(["retentionEnabled", "updatedAt"])
        && request.resource.data.retentionEnabled is bool
        && request.resource.data.updatedAt is timestamp;
    }
    function isPublicAppointmentRead() {
      return resource.data.status == "available";
    }

    function isActiveCenter(centerId) {
      return get(/databases/$(database)/documents/centers/$(centerId)).data.isActive != false;
    }

    function isPublicAppointmentBooking() {
      return resource.data.status == "available"
        && request.resource.data.status == "booked"
        && request.resource.data.centerId == resource.data.centerId
        && request.resource.data.doctorId == resource.data.doctorId
        && request.resource.data.doctorUid == resource.data.doctorUid
        && request.resource.data.date == resource.data.date
        && request.resource.data.time == resource.data.time
        && request.resource.data.patientName is string
        && request.resource.data.patientRut is string
        && request.resource.data.patientPhone is string
        && publicBookingOnlyAllowedFields();
    }

    function publicBookingOnlyAllowedFields() {
      let allowedFields = ['status', 'patientName', 'patientRut', 'patientId', 'patientPhone', 'patientEmail', 'bookedAt', 'bookedBy', 'centerId', 'doctorId', 'doctorUid', 'date', 'time', 'id'];
      return request.resource.data.keys().hasOnly(allowedFields);
    }

    function isPublicPatientCreate(centerId) {
      let allowedFields = [
        'id',
        'centerId',
        'rut',
        'fullName',
        'birthDate',
        'gender',
        'phone',
        'medicalHistory',
        'surgicalHistory',
        'smokingStatus',
        'alcoholStatus',
        'medications',
        'allergies',
        'consultations',
        'attachments',
        'lastUpdated',
        'active',
        'ownerUid',
        'accessControl'
      ];
      return request.resource.data.keys().hasOnly(allowedFields)
        && request.resource.data.centerId == centerId
        && request.resource.data.id is string
        && request.resource.data.rut is string
        && request.resource.data.fullName is string
        && request.resource.data.birthDate is string
        && request.resource.data.gender is string
        && request.resource.data.phone is string
        && request.resource.data.medicalHistory is list
        && request.resource.data.surgicalHistory is list
        && request.resource.data.smokingStatus is string
        && request.resource.data.alcoholStatus is string
        && request.resource.data.medications is list
        && request.resource.data.allergies is list
        && request.resource.data.consultations is list
        && request.resource.data.attachments is list
        && request.resource.data.lastUpdated is string
        && request.resource.data.active == true
        && isActiveCenter(centerId);
    }

    function inviteDoc(token) {
      return get(/databases/$(database)/documents/invites/$(token));
    }

    function inviteValidForSelf(centerId, staffUid, token) {
      return signedIn()
        && staffUid == uid()
        && token is string
        && exists(/databases/$(database)/documents/invites/$(token))
        && inviteDoc(token).data.centerId == centerId
        && inviteDoc(token).data.status == "pending"
        && inviteDoc(token).data.emailLower == emailLower();
    }

    match /centers/{centerId} {
      allow read: if (signedIn() && (isSuperAdmin() || isStaff(centerId)))
        || resource.data.isActive == true;
      allow create: if signedIn() && isSuperAdmin();
      allow update: if isSuperAdmin()
        || canUpdateAnthropometryFeature(centerId)
        || canUpdateAccessMode(centerId);
      allow delete: if signedIn() && isSuperAdmin();

      // -------------------- Center Settings (private) --------------------
      // Example docs:
      // centers/{centerId}/settings/whatsapp   -> WhatsApp templates per center
      match /settings/marketing {
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow create, update: if signedIn() && (isSuperAdmin() || canUpdateMarketingRetention(centerId));
        allow delete: if signedIn() && isSuperAdmin();
      }
      match /settings/{settingId} {
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow create, update, delete: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));
      }

      match /adminNotifications/{notifId} {
        allow read: if signedIn() && isSuperAdmin();
        allow create, update, delete: if false;
      }

      match /billingEvents/{eventId} {
        allow read: if signedIn() && isSuperAdmin();
        allow create, update, delete: if false;
      }

      match /posters/{posterId} {
        allow read: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));
        allow create, update, delete: if false;
      }

      match /stats/postersMonthly/{monthKey} {
        allow read: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));
        allow create, update, delete: if false;
      }


      match /staff/{staffUid} {
        allow read: if signedIn() && (
          isSuperAdmin()
          || (uid() == staffUid)
          || isCenterAdmin(centerId)
        );

        allow create: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || (
            uid() == staffUid
            && inviteValidForSelf(centerId, staffUid, request.resource.data.inviteToken)
          )
        );

        allow update: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || (
            uid() == staffUid
            && onlyAllowedFieldsChanged()
          )
        );

        allow delete: if false;
      }

      function onlyAllowedFieldsChanged() {
        let allowedFields = ['fullName', 'photoUrl', 'phone', 'specialty', 'professionalRole', 'clinicalRole', 'visibleInBooking', 'bio', 'agendaConfig'];
        let changedKeys = request.resource.data.diff(resource.data).affectedKeys();
        return changedKeys.hasOnly(allowedFields);
      }

      function softDeleteKeys() {
        return ['active', 'deletedAt', 'deletedBy', 'deleteReason'];
      }

      function softDeleteKeysChanged() {
        return request.resource.data.diff(resource.data).affectedKeys().hasAny(softDeleteKeys());
      }

      function isSoftDeleteValid() {
        return request.resource.data.active == false
          && (
            resource.data.active == true
            || resource.data.active == null
            || !resource.data.keys().hasAny(["active"])
          )
          && request.resource.data.deletedAt is timestamp
          && request.resource.data.deletedBy is string
          && request.resource.data.deleteReason is string;
      }

      function canArchiveByRetention() {
        return !(resource.data.createdAt is timestamp)
          || request.time < (resource.data.createdAt + duration.value(15, "y"));
      }

      function careTeamKeys() {
        return ["careTeamUids", "careTeamUpdatedAt", "careTeamUpdatedBy"];
      }

      function careTeamKeysChanged() {
        return request.resource.data.diff(resource.data).affectedKeys().hasAny(careTeamKeys());
      }

      function isCareTeamUpdateValid() {
        return request.resource.data.careTeamUids is list
          && request.resource.data.careTeamUids.size() <= 20
          && request.resource.data.careTeamUpdatedAt is timestamp
          && request.resource.data.careTeamUpdatedBy is string;
      }

      function professionalFieldsUnchanged() {
        return request.resource.data.professionalId == resource.data.professionalId
          && request.resource.data.professionalName == resource.data.professionalName
          && request.resource.data.professionalRole == resource.data.professionalRole
          && request.resource.data.professionalRut == resource.data.professionalRut;
      }

      match /publicStaff/{staffUid} {
        // Allow public read of staff members designated for the booking portal.
        // We trust the data in this subcollection is public-ready.
        allow read: if true;
        allow create, update: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));
        allow delete: if false;
      }

      match /settings/{settingId} {
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow create, update, delete: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));
      }

      match /patients/{patientId} {
        allow read: if signedIn()
          && (
            isSuperAdmin()
            || isCenterAdmin(centerId)
            || (isStaff(centerId) && (
              !isCareTeamMode(centerId)
              || isCareTeamMemberFromResource()
            ))
          );
        allow create: if (signedIn() && (isSuperAdmin() || isStaff(centerId)))
          || isPublicPatientCreate(centerId);
        allow update: if signedIn()
          && (isSuperAdmin() || isStaff(centerId))
          && (
            !careTeamKeysChanged()
            || (
              (isSuperAdmin() || isCenterAdmin(centerId))
              && isCareTeamUpdateValid()
            )
          )
          && (
            !softDeleteKeysChanged()
            || (
              (isSuperAdmin() || isCenterAdmin(centerId))
              && isSoftDeleteValid()
              && canArchiveByRetention()
            )
          );
        allow delete: if false;

        match /consultations/{consultationId} {
          allow read: if signedIn()
            && (
              isSuperAdmin()
              || isCenterAdmin(centerId)
              || (isStaff(centerId) && (
                !isCareTeamMode(centerId)
                || isCareTeamMember(centerId, patientId)
              ))
            );
          allow create: if signedIn() && (
            isSuperAdmin()
            || isCenterAdmin(centerId)
            || isDoctor(centerId)
          );
          allow update: if signedIn() && (
            isSuperAdmin()
            || isCenterAdmin(centerId)
            || isDoctor(centerId)
          )
          && professionalFieldsUnchanged()
          && (
            !softDeleteKeysChanged()
            || (
              (isSuperAdmin() || isCenterAdmin(centerId))
              && isSoftDeleteValid()
              && canArchiveByRetention()
            )
          );
          allow delete: if false;
        }

        match /notes/{noteId} {
          allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
          allow create, update: if signedIn() && (isSuperAdmin() || isStaff(centerId));
          allow delete: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));
        }
      }

      match /templates/{templateId} {
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow create: if signedIn() && (isSuperAdmin() || isStaff(centerId));

        allow update: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || (resource.data.ownerUid == uid())
        );

        allow delete: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));
      }

      match /agendas/{uidDoc} {
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow create, update: if signedIn() && (
          isSuperAdmin()
          || (uid() == uidDoc)
          || isCenterAdmin(centerId)
          || isAdministrative(centerId)
        );
        allow delete: if false;
      }

      match /slots/{slotId} {
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow create, update: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || isAdministrative(centerId)
          || (isDoctor(centerId) && request.resource.data.doctorUid == uid())
        );
        allow delete: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId) || isAdministrative(centerId));
      }

      match /appointments/{apptId} {
        allow read: if isPublicAppointmentRead()
          || (
            signedIn()
            && (
              isSuperAdmin()
              || isCenterAdmin(centerId)
              || (isStaff(centerId) && (
                !isCareTeamMode(centerId)
                || !(resource.data.patientId is string)
                || isCareTeamMember(centerId, resource.data.patientId)
              ))
            )
          );
        allow create: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || isAdministrative(centerId)
          || (isDoctor(centerId) && (
            request.resource.data.doctorUid == uid()
            || (request.resource.data.doctorUid == null && request.resource.data.doctorId == uid())
          ))
        );
        allow update: if isPublicAppointmentBooking()
          || (
            signedIn() && (
              isSuperAdmin()
              || isCenterAdmin(centerId)
              || isAdministrative(centerId)
              || (isDoctor(centerId) && (
                request.resource.data.doctorUid == uid()
                || (request.resource.data.doctorUid == null && request.resource.data.doctorId == uid())
              ))
            )
            && (
            !softDeleteKeysChanged()
            || (
              (isSuperAdmin() || isCenterAdmin(centerId) || isAdministrative(centerId))
              && isSoftDeleteValid()
              && canArchiveByRetention()
            )
          )
          );
        allow delete: if false;
      }

      match /consultations/{consultationId} {
        allow read: if signedIn()
          && (
            isSuperAdmin()
            || isCenterAdmin(centerId)
            || (isStaff(centerId) && (
              !isCareTeamMode(centerId)
              || (resource.data.patientId is string
                && isCareTeamMember(centerId, resource.data.patientId))
            ))
          );
        allow create: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || isDoctor(centerId)
        );
        allow update: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || isDoctor(centerId)
        )
        && professionalFieldsUnchanged()
        && (
          !softDeleteKeysChanged()
          || (
            (isSuperAdmin() || isCenterAdmin(centerId))
            && isSoftDeleteValid()
            && canArchiveByRetention()
          )
        );
        allow delete: if false;
      }

      match /preadmissions/{preadmissionId} {
        allow create: if (
          request.resource.data.centerId == centerId
          && request.resource.data.status == "pending"
          && (request.auth == null || isStaff(centerId) || isSuperAdmin())
        );
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow update, delete: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId) || isAdministrative(centerId));
      }

      match /auditLogs/{logId} {
        // Only staff and superadmins can read audit logs
        allow read: if signedIn() && canViewAudit(centerId);
        // No direct writes from client - only through Cloud Functions
        allow create, update, delete: if false;
      }

      match /messageLogs/{logId} {
        // Mensajería transaccional: lectura interna, escritura exclusiva por Functions/Admin SDK
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow create, update, delete: if false;
      }
    }

    match /preadmissions/{docId} {
      allow create: if false;
      allow read, update, delete: if signedIn() && isSuperAdmin();
    }

    match /invites/{token} {
      // ✅ lectura segura (ya no pública)
      allow read: if signedIn() && (
        isSuperAdmin()
        || (resource.data.centerId is string && isCenterAdmin(resource.data.centerId))
        || (resource.data.emailLower is string && resource.data.emailLower == emailLower())
      );

      allow create: if signedIn() && (
        isSuperAdmin()
        || (
          request.resource.data.centerId is string
          && isCenterAdmin(request.resource.data.centerId)
        )
      );

      // ✅ acepta pending -> accepted o pending -> claimed (dueño del correo)
      allow update: if signedIn()
        && (resource.data.emailLower is string && resource.data.emailLower == emailLower())
        && resource.data.status == "pending"
        && (
          (request.resource.data.status == "accepted"
            && request.resource.data.acceptedByUid == uid())
          || (request.resource.data.status == "claimed"
            && request.resource.data.claimedByUid == uid())
        );

      allow delete: if false;
    }

    match /doctors/{docId} { allow read, write: if false; }
    match /appointments/{appId} { allow read, write: if false; }
    match /logs/{logId} { allow read, write: if false; }

    // =====================================================
    // ROOT PATIENTS COLLECTION (Professional-Centric Model)
    // =====================================================
    match /patients/{patientId} {
      // Helper: Is the current user the owner?
      function isOwner() {
        return signedIn() && resource.data.ownerUid == uid();
      }

      // Helper: Is the current user in the allowedUids list?
      function isAllowedProfessional() {
        return signedIn() && (
          uid() in resource.data.accessControl.allowedUids ||
          (resource.data.careTeamUids is list && uid() in resource.data.careTeamUids)
        );
      }

      // Helper: Is the current user a center_admin for any center in centerIds?
      function isCenterAdminOfPatient() {
        return signedIn()
          && resource.data.accessControl.centerIds.size() > 0
          && resource.data.accessControl.centerIds is list;
        // Logic: Client side filtering by centerId + Rule validation.
        // For production, center admins usually check against their specific centers/{id}/staff doc.
      }

    function isPublicRootPatientCreate() {
      let allowedFields = [
        'id', 'centerId', 'rut', 'fullName', 'ownerUid', 'accessControl',
        'birthDate', 'gender', 'phone', 'email',
        'medicalHistory', 'surgicalHistory', 'smokingStatus', 'alcoholStatus', 
        'medications', 'allergies', 'consultations', 'attachments', 'lastUpdated', 'active'
      ];
      return request.auth == null
        && request.resource.data.keys().hasOnly(allowedFields)
        && request.resource.data.id is string
        && request.resource.data.rut is string
        && request.resource.data.fullName is string
        && request.resource.data.ownerUid is string
        && request.resource.data.accessControl is map
        && request.resource.data.accessControl.allowedUids is list
        && request.resource.data.accessControl.centerIds is list
        && request.resource.data.active is bool;
    }

    // Read: owner, allowed professional (including care team), or superadmin
    allow read: if isOwner() || isAllowedProfessional() || isSuperAdmin();

    // Create: any authenticated user can create a patient (they become owner)
    allow create: if (signedIn() && (
      request.resource.data.ownerUid == uid()
      || isSuperAdmin()
    )) || isPublicRootPatientCreate();

      // Update: owner, allowed professional, or superadmin
      allow update: if isOwner() || isAllowedProfessional() || isSuperAdmin();

      // Delete: only owner or superadmin
      allow delete: if (signedIn() && resource.data.ownerUid == uid()) || isSuperAdmin();

      // Consultations as subcollection of patient
      match /consultations/{consultationId} {
        allow read: if signedIn() && (
          get(/databases/$(database)/documents/patients/$(patientId)).data.ownerUid == uid()
          || uid() in get(/databases/$(database)/documents/patients/$(patientId)).data.accessControl.allowedUids
          || (get(/databases/$(database)/documents/patients/$(patientId)).data.careTeamUids is list && 
              uid() in get(/databases/$(database)/documents/patients/$(patientId)).data.careTeamUids)
          || isSuperAdmin()
        );
        allow create, update: if signedIn() && (
          get(/databases/$(database)/documents/patients/$(patientId)).data.ownerUid == uid()
          || uid() in get(/databases/$(database)/documents/patients/$(patientId)).data.accessControl.allowedUids
          || (get(/databases/$(database)/documents/patients/$(patientId)).data.careTeamUids is list && 
              uid() in get(/databases/$(database)/documents/patients/$(patientId)).data.careTeamUids)
          || isSuperAdmin()
        );
        allow delete: if signedIn() && (
          get(/databases/$(database)/documents/patients/$(patientId)).data.ownerUid == uid()
          || isSuperAdmin()
        );
      }
    }
  }
}
