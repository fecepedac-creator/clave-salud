rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function uid() {
      return request.auth.uid;
    }

    function emailLower() {
      return request.auth.token.email != null
        ? request.auth.token.email.toLowerCase()
        : null;
    }

    // ✅ Acepta variantes de claim
    function isSuperAdmin() {
      return signedIn() && (
        request.auth.token.super_admin == true ||
        request.auth.token.superadmin == true ||
        request.auth.token.superAdmin == true
      );
    }

    match /users/{userId} {
      allow read: if signedIn() && (isSuperAdmin() || uid() == userId);
      allow create: if signedIn() && uid() == userId;
      allow update: if signedIn() && (uid() == userId || isSuperAdmin());
      allow delete: if false;
    }

    function staffPath(centerId, staffUid) {
      return /databases/$(database)/documents/centers/$(centerId)/staff/$(staffUid);
    }

    function staffDoc(centerId) {
      return get(staffPath(centerId, uid()));
    }

    // ✅ Compatible: active OR activo
    function isStaff(centerId) {
      return signedIn()
        && exists(staffPath(centerId, uid()))
        && (staffDoc(centerId).data.active == true || staffDoc(centerId).data.activo == true);
    }

    function staffRole(centerId) {
      return isStaff(centerId)
        ? staffDoc(centerId).data.role
        : null;
    }

    function isCenterAdmin(centerId) {
      return isStaff(centerId) && staffRole(centerId) == "center_admin";
    }

    function isDoctor(centerId) {
      return isStaff(centerId) && staffRole(centerId) == "doctor";
    }

    function canViewAudit(centerId) {
      return isSuperAdmin() || isCenterAdmin(centerId);
    }

    function isPublicAppointmentRead() {
      return request.auth == null && resource.data.status == "available";
    }

    function isPublicAppointmentBooking() {
      return request.auth == null
        && resource.data.status == "available"
        && request.resource.data.status == "booked"
        && request.resource.data.centerId == resource.data.centerId
        && request.resource.data.doctorId == resource.data.doctorId
        && request.resource.data.doctorUid == resource.data.doctorUid
        && request.resource.data.date == resource.data.date
        && request.resource.data.time == resource.data.time
        && request.resource.data.patientName is string
        && request.resource.data.patientRut is string
        && request.resource.data.patientPhone is string;
    }

    function inviteDoc(token) {
      return get(/databases/$(database)/documents/invites/$(token));
    }

    function inviteValidForSelf(centerId, staffUid, token) {
      return signedIn()
        && staffUid == uid()
        && token is string
        && exists(/databases/$(database)/documents/invites/$(token))
        && inviteDoc(token).data.centerId == centerId
        && inviteDoc(token).data.status == "pending"
        && inviteDoc(token).data.emailLower == emailLower();
    }

    match /centers/{centerId} {
      allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
      allow create: if isSuperAdmin();
      allow update, delete: if isSuperAdmin();

      match /staff/{staffUid} {
        allow read: if signedIn() && (
          isSuperAdmin()
          || (uid() == staffUid)
          || isCenterAdmin(centerId)
        );

        allow create: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || (
            uid() == staffUid
            && inviteValidForSelf(centerId, staffUid, request.resource.data.inviteToken)
          )
        );

        allow update: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || (uid() == staffUid)
        );

        allow delete: if false;
      }

      match /patients/{patientId} {
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow create, update: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow delete: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));

        match /notes/{noteId} {
          allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
          allow create, update: if signedIn() && (isSuperAdmin() || isStaff(centerId));
          allow delete: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));
        }
      }

      match /templates/{templateId} {
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow create: if signedIn() && (isSuperAdmin() || isStaff(centerId));

        allow update: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || (resource.data.ownerUid == uid())
        );

        allow delete: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));
      }

      match /agendas/{uidDoc} {
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow create, update: if signedIn() && (
          isSuperAdmin()
          || (uid() == uidDoc)
          || isCenterAdmin(centerId)
        );
        allow delete: if false;
      }

      match /slots/{slotId} {
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow create, update: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || (isDoctor(centerId) && request.resource.data.doctorUid == uid())
        );
        allow delete: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));
      }

      match /appointments/{apptId} {
        allow read: if (signedIn() && (isSuperAdmin() || isStaff(centerId))) || isPublicAppointmentRead();
        allow create: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || (isDoctor(centerId) && (
            request.resource.data.doctorUid == uid()
            || (request.resource.data.doctorUid == null && request.resource.data.doctorId == uid())
          ))
        );
        allow update: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || (isDoctor(centerId) && (
            request.resource.data.doctorUid == uid()
            || (request.resource.data.doctorUid == null && request.resource.data.doctorId == uid())
          ))
        ) || isPublicAppointmentBooking();
        allow delete: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));
      }

      match /consultations/{consultationId} {
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow create, update: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || isDoctor(centerId)
        );
        allow delete: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));
      }

      match /preadmissions/{preadmissionId} {
        allow create: if (
          request.resource.data.centerId == centerId
          && request.resource.data.status == "pending"
          && (request.auth == null || isStaff(centerId) || isSuperAdmin())
        );
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow update, delete: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));
      }

      match /auditLogs/{logId} {
        allow read: if signedIn() && canViewAudit(centerId);
        allow create: if signedIn()
          && request.resource.data.actorUid == uid()
          && (isSuperAdmin() || isStaff(centerId));
        allow update, delete: if false;
      }
    }

    match /preadmissions/{docId} {
      allow create: if request.auth == null;
      allow read, update, delete: if signedIn() && isSuperAdmin();
    }

    match /invites/{token} {
      // ✅ lectura segura (ya no pública)
      allow read: if signedIn() && (
        isSuperAdmin()
        || (resource.data.centerId is string && isCenterAdmin(resource.data.centerId))
        || (resource.data.emailLower is string && resource.data.emailLower == emailLower())
      );

      allow create: if signedIn() && (
        isSuperAdmin()
        || (
          request.resource.data.centerId is string
          && isCenterAdmin(request.resource.data.centerId)
        )
      );

      // ✅ acepta pending -> accepted o pending -> claimed (dueño del correo)
      allow update: if signedIn()
        && (resource.data.emailLower is string && resource.data.emailLower == emailLower())
        && resource.data.status == "pending"
        && (
          (request.resource.data.status == "accepted"
            && request.resource.data.acceptedByUid == uid())
          || (request.resource.data.status == "claimed"
            && request.resource.data.claimedByUid == uid())
        );

      allow delete: if false;
    }

    match /doctors/{docId} { allow read, write: if false; }
    match /patients/{patId} { allow read, write: if false; }
    match /appointments/{appId} { allow read, write: if false; }
    match /logs/{logId} { allow read, write: if false; }
  }
}
