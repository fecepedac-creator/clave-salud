rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* =========================
       Helpers generales
    ==========================*/
    function signedIn() {
      return request.auth != null;
    }

    function uid() {
      return request.auth.uid;
    }

    function emailLower() {
      return request.auth.token.email != null
        ? request.auth.token.email.toLowerCase()
        : null;
    }

    /* =========================
       Roles globales (claims)
    ==========================*/
    function isSuperAdmin() {
      return signedIn() && request.auth.token.super_admin == true;
    }

    /* =========================
       Users (compatibilidad con tu login actual)
       - Cada usuario puede leer/escribir su propio perfil.
       - SuperAdmin puede leerlos.
    ==========================*/
    match /users/{userId} {
      allow read: if signedIn() && (isSuperAdmin() || uid() == userId);
      allow create: if signedIn() && uid() == userId;
      allow update: if signedIn() && (uid() == userId || isSuperAdmin());
      allow delete: if false;
    }

    /* =========================
       Helpers por centro
    ==========================*/
    function staffPath(centerId, staffUid) {
      return /databases/$(database)/documents/centers/$(centerId)/staff/$(staffUid);
    }

    function staffDoc(centerId) {
      return get(staffPath(centerId, uid()));
    }

    function isStaff(centerId) {
      return signedIn()
        && exists(staffPath(centerId, uid()))
        && staffDoc(centerId).data.active == true;
    }

    function staffRole(centerId) {
      return isStaff(centerId)
        ? staffDoc(centerId).data.role
        : null;
    }

    function isCenterAdmin(centerId) {
      return isStaff(centerId) && staffRole(centerId) == "center_admin";
    }

    function isDoctor(centerId) {
      return isStaff(centerId) && staffRole(centerId) == "doctor";
    }

    function canViewAudit(centerId) {
      return isSuperAdmin() || isCenterAdmin(centerId);
    }

    /* =========================
       INVITES helpers (para aceptar invitación sin Cloud Functions)
    ==========================*/
    function inviteDoc(token) {
      return get(/databases/$(database)/documents/invites/$(token));
    }

    function inviteValidForSelf(centerId, staffUid, token) {
      // staffUid debe ser el usuario autenticado
      // El invite debe:
      // - existir
      // - estar pending
      // - ser del mismo centerId
      // - emailLower coincide con el del usuario autenticado
      return signedIn()
        && staffUid == uid()
        && token is string
        && exists(/databases/$(database)/documents/invites/$(token))
        && inviteDoc(token).data.centerId == centerId
        && inviteDoc(token).data.status == "pending"
        && inviteDoc(token).data.emailLower == emailLower();
    }

    /* =========================
       CENTERS (tenant root)
    ==========================*/
    match /centers/{centerId} {
      allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
      allow create: if isSuperAdmin();
      allow update, delete: if isSuperAdmin();

      /* ---------- STAFF ---------- */
      match /staff/{staffUid} {

        // SuperAdmin ve todo; miembros ven su propio doc; admin ve su centro
        allow read: if signedIn() && (
          isSuperAdmin()
          || (uid() == staffUid)
          || isCenterAdmin(centerId)
        );

        // Crear staff:
        // - SuperAdmin
        // - CenterAdmin (para su centro)
        // - Invitado creando SU propio staff (vía token)
        allow create: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || (
            uid() == staffUid
            && inviteValidForSelf(centerId, staffUid, request.resource.data.inviteToken)
          )
        );

        // Update staff:
        // - SuperAdmin
        // - CenterAdmin (para su centro)
        // - El propio usuario (solo campos no críticos) -> lo dejamos permitido y tú controlas desde UI
        allow update: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || (uid() == staffUid)
        );

        // Nadie borra staff desde cliente (mejor desactivar/soft-delete)
        allow delete: if false;
      }

      /* ---------- PATIENTS ---------- */
      match /patients/{patientId} {
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow create, update: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow delete: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));

        match /notes/{noteId} {
          allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
          allow create, update: if signedIn() && (isSuperAdmin() || isStaff(centerId));
          allow delete: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));
        }
      }

      /* ---------- TEMPLATES ---------- */
      match /templates/{templateId} {
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow create: if signedIn() && (isSuperAdmin() || isStaff(centerId));

        // Editar:
        // - SuperAdmin
        // - CenterAdmin
        // - Dueño de plantilla (ownerUid)
        allow update: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || (resource.data.ownerUid == uid())
        );

        allow delete: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));
      }

      /* ---------- AGENDA CONFIG (opcional separado) ---------- */
      match /agendas/{uidDoc} {
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow create, update: if signedIn() && (
          isSuperAdmin()
          || (uid() == uidDoc)
          || isCenterAdmin(centerId)
        );
        allow delete: if false;
      }

      /* ---------- SLOTS ---------- */
      match /slots/{slotId} {
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow create, update: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || (isDoctor(centerId) && request.resource.data.doctorUid == uid())
        );
        allow delete: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));
      }

      /* ---------- APPOINTMENTS ---------- */
      match /appointments/{apptId} {
        allow read: if signedIn() && (isSuperAdmin() || isStaff(centerId));
        allow create, update: if signedIn() && (
          isSuperAdmin()
          || isCenterAdmin(centerId)
          || (isDoctor(centerId) && request.resource.data.doctorUid == uid())
        );
        allow delete: if signedIn() && (isSuperAdmin() || isCenterAdmin(centerId));
      }

      /* ---------- AUDIT LOGS ---------- */
      match /auditLogs/{logId} {
        allow read: if signedIn() && canViewAudit(centerId);
        // idealmente desde Cloud Functions; por ahora solo superadmin
        allow create: if signedIn() && isSuperAdmin();
        allow update, delete: if false;
      }
    }

    /* =========================
       INVITES (global)
    ==========================*/
    match /invites/{token} {
      // Leer invite por link (antes de login)
      allow read: if true;

      // Crear invite:
      // - SuperAdmin
      // - CenterAdmin del centro destino
      allow create: if signedIn() && (
        isSuperAdmin()
        || (
          request.resource.data.centerId is string
          && isCenterAdmin(request.resource.data.centerId)
        )
      );

      // Aceptar invite (pending -> accepted por el dueño del correo)
      allow update: if signedIn()
        && resource.data.status == "pending"
        && request.resource.data.status == "accepted"
        && request.resource.data.acceptedByUid == uid();

      // Nadie borra invites desde cliente
      allow delete: if false;
    }

    /* =========================
       BLOQUEO COLECCIONES PLANAS LEGACY
    ==========================*/
    match /doctors/{docId} { allow read, write: if false; }
    match /patients/{patId} { allow read, write: if false; }
    match /appointments/{appId} { allow read, write: if false; }
    match /logs/{logId} { allow read, write: if false; }
  }
}
